{%- if omeroweb_application_server == 'nginx-development' %}
#
# nginx userland template
# this configuration is designed for running nginx as the omero user or similar
# nginx -c etc/nginx.conf
# for inclusion in a system-wide nginx configuration see omero web config nginx
#
pid {{ROOT}}/var/pid.nginx;
error_log {{ROOT}}/var/log/nginx_error.log;
worker_processes  5;
working_directory {{ROOT}}/var;

events {
    worker_connections  1024;
}

http {
    access_log    {{ROOT}}/var/log/nginx_access.log;
    include       {{ROOT}}/etc/mime.types;
    default_type  application/octet-stream;
    client_body_temp_path {{ROOT}}/var/nginx_tmp;

    keepalive_timeout 65;

{%- elif omeroweb_application_server == 'nginx-location' %}
# These location blocks should be included in your server configuration
# For example:
#
##server {
##    listen 80;
##    server_name $hostname;
##
##    # SSL configuration ...
##
##    sendfile on;
##    client_max_body_size 0;
##
##    # Include generated file from omero web config nginx-location:
##    include /opt/omero/web/omero-web-location.include;
##}

{%- endif %}


{%- if omeroweb_application_server != 'nginx-location' %}
upstream omeroweb{{PREFIX_NAME}} {
    server {{FASTCGI_EXTERNAL}} fail_timeout=0;
}

server {
    listen {{HTTPPORT}};

    {%- if omeroweb_application_server == 'nginx-development' %}
        server_name _;
        proxy_temp_path {{ROOT}}/var/nginx_tmp;
    {%- else %}
        server_name {{SERVERNAME}};
    {%- endif %}

    sendfile on;
    client_max_body_size {{MAX_BODY_SIZE}};
{%- endif %}

    # maintenance page serve from here
    location @maintenance{{PREFIX_NAME}} {
        root {{ROOT}}/etc/templates/error;
        try_files $uri /maintainance.html =502;
    }

    # weblitz django apps serve media from here
    location {{STATIC_URL}} {
        alias {{STATIC_ROOT}};
    }

    location @proxy_to_app{{PREFIX_NAME}} {
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_buffering off;

{%- if omeroweb_application_server != 'nginx-location' %}
        proxy_pass http://omeroweb{{PREFIX_NAME}};
{%- else %}
        proxy_pass http://{{FASTCGI_EXTERNAL}};
{%- endif %}
    }

    location {{FORCE_SCRIPT_NAME}} {

        error_page 502 @maintenance{{PREFIX_NAME}};
        # checks for static file, if not found proxy to app
        try_files $uri @proxy_to_app{{PREFIX_NAME}};
    }

{%- if omeroweb_application_server != 'nginx-location' %}
}
{%- endif %}
{%- if omeroweb_application_server == 'nginx-development' %}
}
{%- endif %}
